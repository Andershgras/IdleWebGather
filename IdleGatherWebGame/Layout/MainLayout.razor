@inherits LayoutComponentBase
@using IdleGatherWebGame.Models
@inject IdleGatherWebGame.Services.GameState GS
@implements IDisposable

<div class="app">
    <!-- Top Bar -->
    <header class="topbar">
        <!-- Left: brand + name -->
        <div class="brand">
            IdleGather
            @if (GS.PlayerName is not null)
            {
                <span class="player-name">(@GS.PlayerName)</span>
            }
        </div>
        <!-- Center: activity + progress + details -->
        <div class="activity">
            <div class="activity-line">
                <span class="dot"></span>
                <span class="activity-text">@GS.CurrentActivity</span>
            </div>
            <div class="progress">
                <div style="width:@((GS.Progress01 * 100).ToString("0"))%"></div>
            </div>
            <div class="toasts">
                @foreach (var t in GS.Toasts)
                {
                    <div class="toast chip">
                        <span class="icon">@t.Icon</span>
                        <span>@t.Text</span>
                    </div>
                }
            </div>
            <div class="activity-meta">
                @if (GS.JobRunning)
                {
                    if (GS.ActiveNode is not null)
                    {
                        <span>@GS.ActiveNode.Name</span>
                        <span>•</span>
                        <span>@GS.ActiveOutputText</span>
                        <span>•</span>
                        <span>@GS.AdjustedSecondsRemaining.ToString("0.#")s left</span>
                        @if (GS.ActiveCyclesRemaining.HasValue)
                        {
                            <span>•</span>
                
                            <span>@GS.ActiveCyclesRemaining cycles left</span>
                        }
                        <button class="btn tiny ghost" @onclick="GS.StopChop">Stop</button>
                    }
                    else if (GS.ActiveRecipe is not null)
                    {
                        <span>@GS.ActiveRecipe.Name</span>
                        <span>•</span>
                        <span>@GS.ActiveOutputText</span>
                        <span>•</span>
                        <span>@GS.SecondsRemaining.ToString("0")s left</span>
                        @if (GS.ActiveCyclesRemaining.HasValue)
                        {
                            <span>•</span>
                
                            <span>@GS.ActiveCyclesRemaining cycles left</span>
                        }
                        <button class="btn tiny ghost" @onclick="GS.StopChop">Stop</button>
                    }
                }
                else { <span>Idle</span> }
            </div>
        </div>
        <!-- Right: Overall Level -->
        <div class="r-strip">
            <div class="lvl tooltip-anchor"
                 @onmouseenter="() => _showLvl = true"
                 @onmouseleave="() => _showLvl = false"
                 @onclick="() => _showLvl = !_showLvl">
                <span class="lvl-badge">Lv @GS.OverallLevel</span>

                @if (_showLvl)
                {
                    <div class="tip-pop">
                        <div class="tip-row"><span>Total XP</span><strong>@GS.OverallXp.ToString("0")</strong></div>
                        <div class="tip-row"><span>To next</span><strong>@GS.OverallXpToNextLevel.ToString("0")</strong></div>
                    </div>
                }
            </div>
        </div>
    </header>
    <!-- Character creation modal -->
    @if (GS.PlayerName is null)
    {
        <div class="modal-overlay">
            <div class="modal card">
                <h3>Create Character</h3>
                <input class="input" @bind="newName" maxlength="16" placeholder="Enter name (max 16)..." />
                <div class="row gap">
                    <button class="btn" @onclick="CreateChar">Create</button>
                </div>
            </div>
        </div>
    }
    <!-- Left / Main / Right -->
    <div class="shell">
        <!-- Left column (menus) -->
        <aside class="left card">
            <nav class="menu-vert">
                <button class="menu-item @(leftTab == "Shop" ? "active" : null)"
                        @onclick='() => SetLeft("Shop")'>
                    Shop
                </button>

                <button class="menu-item @(leftTab == "Quests" ? "active" : null)"
                        @onclick='() => SetLeft("Quests")'>
                    Quests
                </button>

                <LeftNav Current="@leftTab" OnChange="SetLeft" />

                <button class="menu-item @(leftTab == "Settings" ? "active" : null)"
                        @onclick='() => SetLeft("Settings")'>
                    Settings
                </button>
            </nav>

        </aside>

        <!-- Main column -->
        <section class="main card">
            @if (leftTab == "Shop")
            {
                <h2>Shop</h2>
                <p>Buy & sell coming later.</p>
            }
            else if (leftTab == "Quests")
            {
                <h2>Quests</h2>
                <p>Simple quest text for now.</p>
            }
            else if (leftTab == "Woodcutting")
            {
                <!-- Woodcutting Area -->
                <h2>Woodcutting</h2>

                <div class="tree-grid">
                    @foreach (var t in GS.TreeNodes)
                    {
                        var locked = !GS.CanChop(t);
                        var isActive = GS.ActiveGatherNodeId == t.Id;

                        <div class="tree-card @(locked ? "locked" : "") @(isActive ? "active-gather" : "")"
                             @onclick="@(() => { if (!locked) { selectedTree = t; showInfo = true; startMsg = ""; } })"
                             style="@(isActive ? "outline:2px solid #0d6efd; background:rgba(13,110,253,.06);" : null)">
                            @* visual fallback *@
                            <div class="tree-icon">@t.Icon</div>
                            <div class="tree-name">@t.Name</div>
                            <div class="tree-req">Req Lv @t.RequiredLevel</div>
                        </div>
                    }
                </div>
                @if (showInfo && selectedTree is not null)
                {
                    var node = selectedTree!;
                    <div class="modal-overlay" @onclick="CloseGatherModal">
                        <div class="modal-box card" @onclick:stopPropagation="true">
                            <h3 style="margin:0 0 1rem 0;">@node.Name</h3>

                            <div class="modal-row">
                                <span class="modal-label">Requires:</span>
                                <span>Woodcutting Lv @node.RequiredLevel</span>
                            </div>

                            <div class="modal-row">
                                <span class="modal-label">Outputs:</span>
                                <div style="display:flex; gap:12px; align-items:center;">
                                    <span>⭐ @Math.Round(node.XpPerCycle) XP</span>
                                    <span>•</span>
                                    <span>@Math.Round(node.MinYield)–@Math.Round(node.MaxYield) Logs</span>
                                </div>
                            </div>

                            <div class="modal-row">
                                <span class="modal-label">Duration:</span>
                                <span>@node.Duration.TotalSeconds.ToString("0.#")s</span>
                            </div>

                            <div class="modal-row" style="margin-top:1rem;">
                                <span class="modal-label">Gather:</span>
                                <div style="display:flex; gap:8px; align-items:center;">
                                    @if (gatherCount == 0)
                                    {
                                        <span style="font-size:1.2rem;">∞</span>
                                    }
                                    else
                                    {
                                        <input class="input small" type="number" min="1"
                                               style="width:80px;"
                                               @bind="gatherCount" @bind:event="oninput" />
                                    }
                                    <button class="btn tiny ghost" @onclick="@(() => gatherCount = 1)">1</button>
                                    <button class="btn tiny ghost" @onclick="@(() => gatherCount = 0)">∞</button>
                                </div>
                            </div>

                            @if (!string.IsNullOrEmpty(startMsg))
                            {
                                <p class="error-msg">@startMsg</p>
                            }

                            <div class="modal-actions">
                                <button class="btn"
                                        disabled="@(!GS.CanChop(node))"
                                        @onclick="@(() => TryStart(node))">
                                    Start Now
                                </button>
                                <button class="btn ghost" @onclick="CloseGatherModal">Cancel</button>
                            </div>
                        </div>
                    </div>
                }
            }
            else if (leftTab == "Clicking")
            {
                <ClickingArea />
            }
            else if (leftTab == "Crafting")
            {
                <!-- Crafting sub-tabs -->
                <div class="subtabs">
                    @foreach (var t in new[] { "Materials", "Tools", "Main Hand", "Off Hand", "Head", "Legs", "Chestplate", "Feet", "Hands" })
                    {
                        <button class="btn ghost subtab @(craftTab == t ? "active" : null)"
                                @onclick="() => SetCraft(t)">
                            @t
                        </button>
                    }
                </div>
                @if (craftTab == "Materials")
                {
                    @MaterialsArea()
                }
                else if (craftTab == "Tools")
                {
                    @ToolsArea()
                }
                else if (craftTab == "Main Hand")
                {
                    <div class="card"><p>Main Hand crafting — WIP</p></div>
                }
                else if (craftTab == "Off Hand")
                {
                    <div class="card"><p>Off Hand crafting — WIP</p></div>
                }
                else if (craftTab == "Head")
                {
                    <div class="card"><p>Head armor crafting — WIP</p></div>
                }
                else if (craftTab == "Legs")
                {
                    <div class="card"><p>Legs armor crafting — WIP</p></div>
                }
                else if (craftTab == "Chestplate")
                {
                    <div class="card"><p>Chestplate crafting — WIP</p></div>
                }
                else if (craftTab == "Feet")
                {
                    <div class="card"><p>Feet armor crafting — WIP</p></div>
                }
                else if (craftTab == "Hands")
                {
                    <div class="card"><p>Hands armor crafting — WIP</p></div>
                }
            }
            else if (leftTab == "Mining")
            {

                @MiningArea()
            }
            else if (leftTab == "Smelting")
            {

                @SmeltingArea()
            }
            else if (leftTab == "Minigames")
            {
                <MinigamesArea />
            }
            else if (leftTab == "Settings")
            {
                <!-- Settings Area -->
                <h2>Settings</h2>
                @if (GS.PlayerName is null)
                {
                    <p>Create a character first.</p>
                }
                else
                {
                    <div class="row gap">
                        <label>Name:</label>
                        <input class="input" maxlength="16" @bind="rename" />
                        <button class="btn" @onclick="@Rename">Save</button>
                    </div>
                }
            }
            else if (leftTab == "Mastery")
            {
                @MasteryArea()
            }
            else if (leftTab == "Casino")
            {
                <div class="casino-tab">
                    <div class="d-flex flex-wrap gap-2 mb-3">
                        <button class="@BtnClass(CasinoGame.Exchange)"  @onclick="() => SelectGame(CasinoGame.Exchange)">Exchange</button>
                        <button class="@BtnClass(CasinoGame.CoinFlip)" @onclick="() => SelectGame(CasinoGame.CoinFlip)">Coin Flip</button>
                        <button class="@BtnClass(CasinoGame.Roulette)" @onclick="() => SelectGame(CasinoGame.Roulette)">Roulette</button>
                        <button class="@BtnClass(CasinoGame.Blackjack)" @onclick="() => SelectGame(CasinoGame.Blackjack)">Blackjack</button>
                    </div>

                    <div class="mt-2">
                        @(_selectedCasinoGame switch
                        {
                            CasinoGame.Exchange => ExchangeView,
                            CasinoGame.CoinFlip => CoinFlipView,
                            CasinoGame.Roulette => RouletteView,
                            CasinoGame.Blackjack => BlackjackView,
                            _ => DefaultView
                        })
                </div>
            </div>
                        }
        </section>
        <!-- Right column -->
        <aside class="right card"
               tabindex="0"
               @onmousedown="HandleRightClickAway">
            <!-- Tabs -->
            <div style="display:flex; gap:8px; margin-bottom:8px;">
                <button @onclick='() => ToggleRight(TabInventory)'
                        style="
            flex:1; display:flex; align-items:center; justify-content:center;
            background:@(rightTab == TabInventory ? "#2a2b33" : "transparent");
            border:1px solid #3a3b44; border-radius:6px; color:#cdd4f5;
            font-weight:700; padding:8px 10px; cursor:pointer;">
                    🎒 Inventory
                </button>

                <button @onclick='() => ToggleRight(TabGear)'
                        style="
            flex:1; display:flex; align-items:center; justify-content:center;
            background:@(rightTab == TabGear ? "#2a2b33" : "transparent");
            border:1px solid #3a3b44; border-radius:6px; color:#cdd4f5;
            font-weight:700; padding:8px 10px; cursor:pointer;">
                    🛡️ Gear
                </button>

                <button @onclick='() => ToggleRight(TabBase)'
                        style="
            flex:1; display:flex; align-items:center; justify-content:center;
            background:@(rightTab == TabBase ? "#2a2b33" : "transparent");
            border:1px solid #3a3b44; border-radius:6px; color:#cdd4f5;
            font-weight:700; padding:8px 10px; cursor:pointer;">
                    🏝️ Base
                </button>
            </div>

            @* Only one of these blocks renders at a time *@
            @if (rightTab == TabInventory)
            {
                @* INVENTORY (your new grid version) *@
                @if (!GetInventoryGroups().Any())
                {
                    <p class="small">You haven’t obtained any items yet.</p>
                }
                else
                {
                    @foreach (var group in GetInventoryGroups())
                    {
                        <div class="inv-section">
                            <h4 class="inv-title">@group.Category</h4>

                            <div class="inv-grid">
                                @foreach (var item in group.Items)
                                {
                                    var id = item.Meta.Id;
                                    var amt = item.Amount;
                                    var hasPrice = GS.TryGetSellPrice(id, out var unitPrice);

                                    <div class="inv-item"
                                        @onmousedown:stopPropagation="true"
                                        @onclick="@(() => OpenItemPanel(id, amt))">
                                        @if (ItemRegistry.TryGet(id, out var meta))
                                        {
                                            if (LooksLikeImage(meta.Icon))
                                            {
                                                <img class="inv-img" src="@meta.Icon" alt="@meta.Name" />
                                            }
                                            else
                                            {
                                                <div class="inv-emoji">@meta.Icon</div>
                                            }
                                        }
                                        else
                                        {
                                            <div class="inv-emoji">❔</div>
                                        }


                                        <span class="inv-badge">@FormatQty(amt)</span>

                                        <div class="inv-tip inv-pop">
                                            <div class="tip-name">@item.Meta.Name</div>
                                            <div class="tip-cat">@group.Category</div>
                                            <div class="tip-amt">Owned: @Math.Floor(amt)</div>
                                            @if (hasPrice)
                                            {
                                                <div class="tip-amt">Sell Price: @unitPrice</div>
                                            }
                                        </div>
                                    </div>


                                }

                            </div>

                            @if (selectedItemId is not null && group.Items.Any(i => i.Meta.Id == selectedItemId))
                            {
                                var meta = group.Items.First(i => i.Meta.Id == selectedItemId).Meta;
                                var hasPrice = GS.TryGetSellPrice(selectedItemId, out var p);
                                var isTool = meta.Category == "Tools";

                                <div class="sell-panel card" @onmousedown:stopPropagation="true">
                                    <div class="sell-title">@Math.Floor(SelectedItemOwned) @meta.Name</div>
                                    @if (isTool)
                                    {
                                        <div class="sell-row">
                                            <button class="btn wide"
                                                    disabled="@(SelectedItemOwned < 1)"
                                                    @onclick="EquipSelected">
                                                Equip
                                            </button>
                                        </div>
                                    }
                                    <div class="sell-row">
                                        <input class="input small" type="number" min="1" max="@MaxSellAll"
                                               @bind="sellAmount" @bind:event="oninput" />
                                        <button class="btn tiny ghost" @onclick="@(() => sellAmount = 1)">1</button>
                                        <button class="btn tiny ghost" @onclick="@(() => sellAmount = Math.Max(1, MaxSellAll))">All</button>
                                    </div>

                                    @if (hasPrice)
                                    {
                                        <div class="sell-row">
                                            <button class="btn wide"
                                                    disabled="@(sellAmount <= 0 || sellAmount > MaxSellAll)"
                                                    @onclick="SellSelected">
                                                Sell for @(sellAmount* p) Coins
                                            </button>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="sell-row">
                                            <span class="small">This item cannot be sold.</span>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                }
            }
            else if (rightTab == TabGear)
            {
                <GearPanel />
            }
            else if (rightTab == TabBase)
            {
                @BasePanel()
            }
        </aside>
    </div>
</div>

@code {
    // ---------- Tabs / UI ----------
    string leftTab = "Woodcutting";
    string newName = "";
    string rename = "";

    // ---------- Selection ----------
    WorkNode? selectedTree;
    bool showInfo = false;

    // ---------- Gather cycles (0 = infinite) ----------
    int gatherCount = 0;

    // ---------- Start feedback / debug ----------
    string startMsg = "";

    string Fmt(double v) => v.ToString("0");
    void SetLeft(string t) => leftTab = t;

    void CreateChar()
    {
        GS.CreateCharacter(newName);
        StateHasChanged();
    }

    // ----- lifecycle / autosave wiring -----
    private bool _autosaveHooked = false;

    private bool _subscribed;

    // Load after first render (JS runtime ready) + hook autosave once
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        await GS.LoadFromLocalAsync();

        if (!_subscribed)
        {
            GS.OnChange += StateHasChanged;
            GS.OnChange += OnGameStateChanged;
            _subscribed = true;
        }
    }
    private async void OnGameStateChanged()
    {
        try
        {
            await GS.SaveToLocalAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Save failed: {ex.Message}");
        }
    }
    public void Dispose()
    {
        if (_subscribed)
        {
            GS.OnChange -= StateHasChanged;
            GS.OnChange -= OnGameStateChanged;
            _subscribed = false;
        }
    }

    bool TryStart(WorkNode node)
    {
        int? cycles = (gatherCount <= 0) ? null : gatherCount;

        if (GS.PlayerName is null)
        {
            startMsg = "Create a character first.";
            StateHasChanged();
            return false;
        }
        if (!GS.CanChop(node))
        {
            startMsg = $"Requires Woodcutting Lv {node.RequiredLevel}.";
            StateHasChanged();
            return false;
        }

        bool ok = GS.StartChop(node, cycles);
        if (ok)
        {
            CloseGatherModal();
        }
        else
        {
            startMsg = "Could not start job (unexpected).";
        }
        StateHasChanged();
        return ok;
    }

    void Rename()
    {
        if (GS.PlayerName is null) return;
        GS.CreateCharacter(rename);
    }

    private class InvMeta
    {
        public string Id { get; }
        public string Name { get; }
        public string Category { get; }
        public string Img { get; }
        public string Description { get; }
        public InvMeta(string id, string name, string cat, string img, string desc)
        { Id = id; Name = name; Category = cat; Img = img; Description = desc; }
    }
    private class InvItem { public InvMeta Meta { get; set; } = default!; public double Amount { get; set; } }
    private class InvGroup { public string Category { get; set; } = ""; public List<InvItem> Items { get; set; } = new(); }

    // Inline SVG placeholders
    private const string IMG_WOOD = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Crect width='64' height='64' rx='12' fill='%232a3a1f'/%3E%3Ctext x='50%25' y='54%25' dominant-baseline='middle' text-anchor='middle' font-size='40'%3E%F0%9F%8C%B2%3C/text%3E%3C/svg%3E";
    private const string IMG_STONE = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Crect width='64' height='64' rx='12' fill='%23272b36'/%3E%3Ctext x='50%25' y='54%25' dominant-baseline='middle' text-anchor='middle' font-size='40'%3E%F0%9F%AA%A8%3C/text%3E%3C/svg%3E";
    private const string IMG_KEYS = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Crect width='64' height='64' rx='12' fill='%233a2f16'/%3E%3Ctext x='50%25' y='54%25' dominant-baseline='middle' text-anchor='middle' font-size='40'%3E%F0%9F%97%9D%EF%B8%8F%3C/text%3E%3C/svg%3E";
    private const string IMG_COINS = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Crect width='64' height='64' rx='12' fill='%236b5500'/%3E%3Ctext x='50%25' y='54%25' dominant-baseline='middle' text-anchor='middle' font-size='40'%3E%F0%9F%AA%99%3C/text%3E%3C/svg%3E";
    private const string IMG_PLANK = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Crect width='64' height='64' rx='12' fill='%23402a14'/%3E%3Ctext x='50%25' y='54%25' dominant-baseline='middle' text-anchor='middle' font-size='40'%3E%F0%9F%AA%B5%3C/text%3E%3C/svg%3E";
    private const string IMG_ORE = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Crect width='64' height='64' rx='12' fill='%23272b36'/%3E%3Ctext x='50%25' y='54%25' dominant-baseline='middle' text-anchor='middle' font-size='40'%3E%F0%9F%AA%A8%3C/text%3E%3C/svg%3E";
    private const string IMG_BAR = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Crect width='64' height='64' rx='12' fill='%23323a3f'/%3E%3Ctext x='50%25' y='54%25' dominant-baseline='middle' text-anchor='middle' font-size='40'%3E%F0%9F%94%A9%3C/text%3E%3C/svg%3E";

    private readonly Dictionary<string, InvMeta> _invMeta = new()
    {
        // Currency
        ["chips"] = new InvMeta("chips", "Chips", "Currencies", IMG_COINS, "Casino chips used to play games."),
        ["coins"] = new InvMeta("coins", "Coins", "Currencies", IMG_COINS, "The main currency."),
		["mastery_token"] = new InvMeta("mastery_token", "Mastery Token", "Currencies", IMG_KEYS, "Token used to unlock mastery rewards."),
        // Logs
        ["log_t1"] = new InvMeta("log_t1", "Log (T1)", "Resources", IMG_WOOD, "Common logs from shrubs."),
        ["log_t2"] = new InvMeta("log_t2", "Log (T2)", "Resources", IMG_WOOD, "Sturdy oak logs."),
        ["log_t3"] = new InvMeta("log_t3", "Log (T3)", "Resources", IMG_WOOD, "Willow logs."),
        ["log_t4"] = new InvMeta("log_t4", "Log (T4)", "Resources", IMG_WOOD, "Maple logs."),
        ["log_t5"] = new InvMeta("log_t5", "Log (T5)", "Resources", IMG_WOOD, "Yew logs."),
        ["log_t6"] = new InvMeta("log_t6", "Log (T6)", "Resources", IMG_WOOD, "Magic logs."),
        ["log_t7"] = new InvMeta("log_t7", "Log (T7)", "Resources", IMG_WOOD, "Elder logs."),
		// Planks
        ["plank_t1"] = new InvMeta("plank_t1", "Plank (T1)", "Materials", IMG_PLANK, "A basic wooden plank."),
		["plank_t2"] = new InvMeta("plank_t2", "Plank (T2)", "Materials", IMG_PLANK, "A standard wooden plank."),
        ["plank_t3"] = new InvMeta("plank_t3", "Plank (T3)", "Materials", IMG_PLANK, "A refined wooden plank."),
        ["plank_t4"] = new InvMeta("plank_t4", "Plank (T4)", "Materials", IMG_PLANK, "A high-quality wooden plank."),
        ["plank_t5"] = new InvMeta("plank_t5", "Plank (T5)", "Materials", IMG_PLANK, "An excellent wooden plank."),
        ["plank_t6"] = new InvMeta("plank_t6", "Plank (T6)", "Materials", IMG_PLANK, "A superior wooden plank."),
		["plank_t7"] = new InvMeta("plank_t7", "Plank (T7)", "Materials", IMG_PLANK, "A masterwork wooden plank."),
        // Ores
        ["copper_ore"] = new InvMeta("copper_ore", "Copper Ore", "Resources", IMG_STONE, "Ore for smelting."),
        ["tin_ore"] = new InvMeta("tin_ore", "Tin Ore", "Resources", IMG_STONE, "Ore for smelting."),
        ["iron_ore"] = new InvMeta("iron_ore", "Iron Ore", "Resources", IMG_STONE, "Ore for smelting."),
        ["silver_ore"] = new InvMeta("silver_ore", "Silver Ore", "Resources", IMG_ORE, "Ore for smelting."),
        ["gold_ore"] = new InvMeta("gold_ore", "Gold Ore", "Resources", IMG_ORE, "Ore for smelting."),
        ["mithril_ore"] = new InvMeta("mithril_ore", "Mithril Ore", "Resources", IMG_ORE, "Ore for smelting."),
        ["adamant_ore"] = new InvMeta("adamant_ore", "Adamantite Ore", "Resources", IMG_ORE, "Ore for smelting."),
        // Bars
        ["bronze_bar"] = new InvMeta("bronze_bar", "Bronze Bar", "Materials", IMG_BAR, "Smelted alloy."),
        ["iron_bar"] = new InvMeta("iron_bar", "Iron Bar", "Materials", IMG_BAR, "Smelted iron."),
        ["silver_bar"] = new InvMeta("silver_bar", "Silver Bar", "Materials", IMG_BAR, "Smelted metal."),
        ["gold_bar"] = new InvMeta("gold_bar", "Gold Bar", "Materials", IMG_BAR, "Smelted metal."),
        ["mith_bar"] = new InvMeta("mith_bar", "Mithril Bar", "Materials", IMG_BAR, "Smelted metal."),
        ["adam_bar"] = new InvMeta("adam_bar", "Adamant Bar", "Materials", IMG_BAR, "Smelted metal."),
        // Tools
        ["axe_t1"] = new InvMeta("axe_t1", "Axe (T1)", "Tools", IMG_PLANK, "A basic woodcutting tool."),
        ["axe_t2"] = new InvMeta("axe_t2", "Axe (T2)", "Tools", IMG_PLANK, "An improved woodcutting tool."),
        ["axe_t3"] = new InvMeta("axe_t3", "Axe (T3)", "Tools", IMG_PLANK, "An advanced woodcutting tool."),
        ["axe_t4"] = new InvMeta("axe_t4", "Axe (T4)", "Tools", IMG_PLANK, "A masterwork woodcutting tool."),

        ["saw_t1"] = new InvMeta("saw_t1", "Saw (T1)", "Tools", IMG_PLANK, "A basic crafting tool."),
        ["saw_t2"] = new InvMeta("saw_t2", "Saw (T2)", "Tools", IMG_PLANK, "An improved crafting tool."),
        ["saw_t3"] = new InvMeta("saw_t3", "Saw (T3)", "Tools", IMG_PLANK, "An advanced crafting tool."),
        ["saw_t4"] = new InvMeta("saw_t4", "Saw (T4)", "Tools", IMG_PLANK, "A masterwork crafting tool."),

        ["pickaxe_t1"] = new InvMeta("pickaxe_t1", "Pickaxe (T1)", "Tools", IMG_STONE, "A basic mining tool."),
        ["pickaxe_t2"] = new InvMeta("pickaxe_t2", "Pickaxe (T2)", "Tools", IMG_STONE, "An improved mining tool."),
        ["pickaxe_t3"] = new InvMeta("pickaxe_t3", "Pickaxe (T3)", "Tools", IMG_STONE, "An advanced mining tool."),
        ["pickaxe_t4"] = new InvMeta("pickaxe_t4", "Pickaxe (T4)", "Tools", IMG_STONE, "A masterwork mining tool."),
    };
    // sell-panel state
    string? selectedItemId = null;
    int sellAmount = 1;
    double SelectedItemOwned => selectedItemId is null ? 0 : GS.GetAmount(selectedItemId);
    int MaxSellAll => (int)Math.Floor(SelectedItemOwned);

    private List<InvGroup> GetInventoryGroups()
    {
        var byCat = new Dictionary<string, InvGroup>();

        foreach (var kv in GS.Resources)
        {
            var id = kv.Key;
            var amount = kv.Value.Amount;
            if (amount <= 0) continue;

            if (!_invMeta.TryGetValue(id, out var meta))
            {
                // fallback so new items still show up
                meta = new InvMeta(id, IdToNice(id), "Other", IMG_ORE, "");
            }
            if (!byCat.TryGetValue(meta.Category, out var group))
            {
                group = new InvGroup { Category = meta.Category, Items = new List<InvItem>() };
                byCat[meta.Category] = group;
            }

            group.Items.Add(new InvItem { Meta = meta, Amount = amount });
        }

        var groups = byCat.Values.OrderBy(g => g.Category).ToList();
        foreach (var g in groups)
            g.Items = g.Items.OrderBy(i => i.Meta.Name).ToList();

        return groups;
    }

    void OpenItemPanel(string id, double owned)
    {
        selectedItemId = id;
        sellAmount = owned >= 1 ? 1 : 0;
    }

    void SellSelected()
    {
        if (selectedItemId is null) return;
        var qty = Math.Clamp(sellAmount, 0, MaxSellAll);
        if (qty <= 0) return;

        var earned = GS.Sell(selectedItemId, qty); // adds coins, subtracts item
        sellAmount = Math.Clamp(sellAmount, 1, MaxSellAll);
    }
    private Dictionary<string, double> _high = new();
    private int _gamesPlayed = 0;

    private void PlayStub(string id) // Debug method to simulate playing - to be removed later
    {
        // simulate a score: 0–100
        var score = Math.Round(Random.Shared.NextDouble() * 100, 0);
        GS.SubmitMinigameScore(id, score);

        // refresh local view
        _gamesPlayed++;
        if (!_high.ContainsKey(id) || score > _high[id]) _high[id] = score;
        StateHasChanged();
    }
    // ------ Crafting UI ------
    IdleGatherWebGame.Services.GameState.CraftRecipe? selectedRecipe;
    bool showCraft = false;
    int craftCount = 0; // 0 = infinite
    string craftMsg = "";

    RenderFragment MaterialsArea() => __builder =>
    {
        <h2>Planks</h2>

        <div class="tree-grid">
            @foreach (var r in GS.CraftingRecipes)
            {
                var locked = GS.Crafting.Level < r.RequiredLevel;
                var isActive = GS.ActiveRecipeId == r.Id;

                <div class="tree-card @(locked ? "locked" : "") @(isActive ? "active-gather" : "")"
                     style="@(isActive ? "outline:2px solid #0d6efd; background:rgba(13,110,253,.06);" : null)"
                     @onclick="@(() => { if (!locked) { selectedRecipe = r; showCraft = true; craftMsg = ""; } })">
                    <div class="tree-icon">@r.Icon</div>
                    <div class="tree-name">@r.Name</div>
                    <div class="tree-req">Req Lv @r.RequiredLevel</div>
                </div>
            }
        </div>

        @if (showOre && selectedOre is not null)
        {
            var n = selectedOre!;
            <div class="modal-overlay" @onclick="CloseMiningModal">
                <div class="modal-box card" @onclick:stopPropagation="true">
                    <h3 style="margin:0 0 1rem 0;">@n.Name</h3>

                    <div class="modal-row">
                        <span class="modal-label">Requires:</span>
                        <span>Mining Lv @n.RequiredLevel</span>
                    </div>

                    <div class="modal-row">
                        <span class="modal-label">Outputs:</span>
                        <div style="display:flex; gap:12px; align-items:center;">
                            <span>⭐ @Math.Round(n.XpPerCycle) XP</span>
                            <span>•</span>
                            <span>@Math.Round(n.MinYield)–@Math.Round(n.MaxYield) Ore</span>
                        </div>
                    </div>

                    <div class="modal-row">
                        <span class="modal-label">Duration:</span>
                        <span>@n.Duration.TotalSeconds.ToString("0.#")s</span>
                    </div>

                    <div class="modal-row" style="margin-top:1rem;">
                        <span class="modal-label">Mine:</span>
                        <div style="display:flex; gap:8px; align-items:center;">
                            @if (mineCount == 0)
                            {
                                <span style="font-size:1.2rem;">∞</span>
                            }
                            else
                            {
                                <input class="input small" type="number" min="1"
                                       style="width:80px;"
                                       @bind="mineCount" @bind:event="oninput" />
                            }
                            <button class="btn tiny ghost" @onclick="@(() => mineCount = 1)">1</button>
                            <button class="btn tiny ghost" @onclick="@(() => mineCount = 0)">∞</button>
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(mineMsg))
                    {
                        <p class="error-msg">@mineMsg</p>
                    }

                    <div class="modal-actions">
                        <button class="btn"
                                disabled="@(!GS.CanMine(n))"
                                @onclick="@(() => TryStartMine(n))">
                            Start Now
                        </button>
                        <button class="btn ghost" @onclick="CloseMiningModal">Cancel</button>
                    </div>
                </div>
            </div>
        }
    };

    bool TryStartCraft(IdleGatherWebGame.Services.GameState.CraftRecipe r)
    {
        if (GS.PlayerName is null) { craftMsg = "Create a character first."; StateHasChanged(); return false; }
        if (GS.Crafting.Level < r.RequiredLevel) { craftMsg = $"Requires Crafting Lv {r.RequiredLevel}."; StateHasChanged(); return false; }
        if (!HasInputsOnce(r)) { craftMsg = "Not enough materials for one craft."; StateHasChanged(); return false; }

        int? cycles = (craftCount <= 0) ? null : craftCount;
        var ok = GS.StartCraft(r, cycles);
        craftMsg = ok ? "" : "Could not start crafting.";
        StateHasChanged();
        return ok;
    }

    // local helper to print ids like “wood” => “Logs”
    string IdToNice(string id) => id switch
    {
        "wood" => "Logs",
        "plank_t1" => "Plank (T1)",
        "plank_t2" => "Plank (T2)",
        "plank_t3" => "Plank (T3)",
        "plank_t4" => "Plank (T4)",
        "plank_t5" => "Plank (T5)",
        "plank_t6" => "Plank (T6)",
        "plank_t7" => "Plank (T7)",
        "copper_ore" => "Copper Ore",
        "tin_ore" => "Tin Ore",
        "iron_ore" => "Iron Ore",
        "silver_ore" => "Silver Ore",
        "gold_ore" => "Gold Ore",
        "mithril_ore" => "Mithril Ore",
        "adamant_ore" => "Adamantite Ore",
        "bronze_bar" => "Bronze Bar",
        "iron_bar" => "Iron Bar",
        "silver_bar" => "Silver Bar",
        "gold_bar" => "Gold Bar",
        "mith_bar" => "Mithril Bar",
        "adam_bar" => "Adamant Bar",
        _ => id.Replace('_', ' ')
    };
    bool HasInputsOnce(IdleGatherWebGame.Services.GameState.CraftRecipe r)
        => r.Inputs.All(i => Math.Floor(GS.GetAmount(i.ResourceId)) >= i.Amount);

    private void OnActiveClick()
    {
        GS.RegisterClick();
    }
    // ===== Mining Area =====
    WorkNode? selectedOre;
    bool showOre = false;
    int mineCount = 0; // 0 = infinite
    string mineMsg = "";

    RenderFragment MiningArea() => __builder =>
{
    <h2>Mining</h2>

    <div class="tree-grid">
        @foreach (var n in GS.OreNodes)
        {
            var locked = !GS.CanMine(n);
            var isActive = GS.ActiveGatherNodeId == n.Id; // highlight if this ore is being mined

            <div class="tree-card @(locked ? "locked" : "") @(isActive ? "active-gather" : "")"
                 style="@(isActive ? "outline:2px solid #0d6efd; background:rgba(13,110,253,.06);" : null)"
                 @onclick="@(() => { if (!locked) { selectedOre = n; showOre = true; mineMsg = ""; } })">
                <div class="tree-icon">@n.Icon</div>
                <div class="tree-name">@n.Name</div>
                <div class="tree-req">Req Lv @n.RequiredLevel</div>
            </div>
        }
    </div>

    @if (showOre && selectedOre is not null)
    {
        var n = selectedOre!;
        <div class="modal-overlay" @onclick="CloseMiningModal">
            <div class="modal-box card" @onclick:stopPropagation="true">
                <h3 style="margin:0 0 1rem 0;">@n.Name</h3>

                <div class="modal-row">
                    <span class="modal-label">Requires:</span>
                    <span>Mining Lv @n.RequiredLevel</span>
                </div>

                <div class="modal-row">
                    <span class="modal-label">Outputs:</span>
                    <div style="display:flex; gap:12px; align-items:center;">
                        <span>⭐ @Math.Round(n.XpPerCycle) XP</span>
                        <span>•</span>
                        <span>@Math.Round(n.MinYield)–@Math.Round(n.MaxYield) Ore</span>
                    </div>
                </div>

                <div class="modal-row">
                    <span class="modal-label">Duration:</span>
                    <span>@n.Duration.TotalSeconds.ToString("0.#")s</span>
                </div>

                <div class="modal-row" style="margin-top:1rem;">
                    <span class="modal-label">Mine:</span>
                    <div style="display:flex; gap:8px; align-items:center;">
                        @if (mineCount == 0)
                        {
                            <span style="font-size:1.2rem;">∞</span>
                        }
                        else
                        {
                            <input class="input small" type="number" min="1"
                                   style="width:80px;"
                                   @bind="mineCount" @bind:event="oninput" />
                        }
                        <button class="btn tiny ghost" @onclick="@(() => mineCount = 1)">1</button>
                        <button class="btn tiny ghost" @onclick="@(() => mineCount = 0)">∞</button>
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(mineMsg))
                {
                    <p class="error-msg">@mineMsg</p>
                }

                <div class="modal-actions">
                    <button class="btn"
                            disabled="@(!GS.CanMine(n))"
                            @onclick="@(() => TryStartMine(n))">
                        Start Now
                    </button>
                    <button class="btn ghost" @onclick="CloseMiningModal">Cancel</button>
                </div>
            </div>
        </div>
    }
    };

    bool TryStartMine(WorkNode n)
    {
        if (GS.PlayerName is null) { mineMsg = "Create a character first."; StateHasChanged(); return false; }
        if (!GS.CanMine(n)) { mineMsg = $"Requires Mining Lv {n.RequiredLevel}."; StateHasChanged(); return false; }
        int? cycles = (mineCount <= 0) ? null : mineCount;
        var ok = GS.StartMine(n, cycles);
        if (ok)
        {
            CloseMiningModal(); // ← ADD
        }
        else
        {
            mineMsg = "Could not start mining.";
        }
        StateHasChanged();
        return ok;
    }
    IdleGatherWebGame.Services.GameState.CraftRecipe? selectedSmelt;
    bool showSmelt = false;
    int smeltCount = 0; // 0 = infinite
    string smeltMsg = "";

    RenderFragment MasteryArea() => __builder =>
    {
        <div class="card" style="margin-bottom:10px;">
            <h2>Mastery</h2>
            <p class="small">Level @GS.Mastery.Level — @GS.Mastery.Xp.ToString("0") / @GS.Mastery.XpForNextLevel.ToString("0") XP</p>
        </div>

        <div style="display:grid;gap:10px;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));">
            @foreach (var row in GetMasteryRows())
            {
                <div class="card" style="padding:10px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div style="font-weight:700;">@row.name</div>
                        <div class="small" style="opacity:.8;">Tier <b>@row.tier</b></div>
                    </div>

                    <div class="small" style="margin:.25rem 0 .5rem;">
                        @row.count / @row.target
                    </div>

                    <div style="background:#2a2b33;border:1px solid #3a3b44;border-radius:6px;height:10px;overflow:hidden;">
                        <div style="height:100%;background:#0d6efd;width:@BarWidth(row.count, row.target)"></div>
                    </div>
                </div>
            }
        </div>
    };

    RenderFragment SmeltingArea() => __builder =>
{
    <h2>Smelting</h2>
    <div class="tree-grid">
        @foreach (var r in GS.SmeltingRecipes)
        {
            var locked = GS.Smelting.Level < r.RequiredLevel;
            var isActive = GS.ActiveRecipeId == r.Id;  // highlight if this recipe is currently running

            <div class="tree-card @(locked ? "locked" : "") @(isActive ? "active-gather" : "")"
                 style="@(isActive ? "outline:2px solid #0d6efd; background:rgba(13,110,253,.06);" : null)"
                 @onclick="@(() => { if (!locked) { selectedSmelt = r; showSmelt = true; smeltMsg = ""; } })">
                <div class="tree-icon">@r.Icon</div>
                <div class="tree-name">@r.Name</div>
                <div class="tree-req">Req Lv @r.RequiredLevel</div>
            </div>
        }
    </div>

    @if (showSmelt && selectedSmelt is not null)
    {
        var r = selectedSmelt!;
        <div class="info card">
            <h3>@r.Name</h3>
            <div class="kv"><span>Requires:</span> <span>Smelting Lv @r.RequiredLevel</span></div>
            <div class="kv"><span>Inputs:</span> <span>@string.Join(", ", r.Inputs.Select(i => $"{i.Amount} {IdToNice(i.ResourceId)}"))</span></div>
            <div class="kv"><span>Outputs:</span> <span>@string.Join(", ", r.Outputs.Select(o => $"{o.Amount} {IdToNice(o.ResourceId)}"))</span></div>
            <div class="kv"><span>Duration:</span> <span>@r.Duration.TotalSeconds.ToString("0.#")s</span></div>

            <div class="row gap">
                <label>Smelt (0 = ∞):</label>
                <input class="input small" type="number" min="0" @bind="smeltCount" @bind:event="oninput" />
            </div>

            @if (!string.IsNullOrEmpty(smeltMsg))
            {
                <p class="small" style="color:#f7b3b3">@smeltMsg</p>
            }

            <div class="row gap">
                <button class="btn" type="button"
                        disabled="@(GS.Smelting.Level < r.RequiredLevel || !HasInputsOnce(r))"
                        @onclick="@(() => TryStartSmelt(r))">
                    Start
                </button>
                <button class="btn ghost" type="button" @onclick="@(() => showSmelt = false)">Close</button>
            </div>
        </div>
    }
};
    bool TryStartSmelt(IdleGatherWebGame.Services.GameState.CraftRecipe r)
    {
        if (GS.PlayerName is null) { smeltMsg = "Create a character first."; StateHasChanged(); return false; }
        if (GS.Smelting.Level < r.RequiredLevel) { smeltMsg = $"Requires Smelting Lv {r.RequiredLevel}."; StateHasChanged(); return false; }
        if (!HasInputsOnce(r)) { smeltMsg = "Not enough materials."; StateHasChanged(); return false; }

        int? cycles = (smeltCount <= 0) ? null : smeltCount;
        var ok = GS.StartSmelt(r, cycles);
        smeltMsg = ok ? "" : "Could not start smelting.";
        StateHasChanged();
        return ok;
    }
    bool _showLvl;
    // CASINO AREA
    private enum CasinoGame { None, Exchange, CoinFlip, Roulette, Blackjack }
    private CasinoGame _selectedCasinoGame = CasinoGame.None;

    private void SelectGame(CasinoGame game) => _selectedCasinoGame = game;

    private string BtnClass(CasinoGame game)
        => $"btn {(_selectedCasinoGame == game ? "btn-primary" : "btn-outline-primary")}";
    // --- Exchange state ---
    private double _exchangeAmount = 0;
    private string _exchangeMsg = string.Empty;
    // Inline "components" (no extra files needed)
    private RenderFragment DefaultView => @<p>Select a game above.</p>;
	// --- Exchange logic ---
    private RenderFragment ExchangeView => @<div class="card p-3">
    <h4>Exchange Coins → Chips</h4>
    <div class="mb-2">
        <strong>Coins:</strong> @Format(GS.GetAmount("coins"))
        &nbsp; • &nbsp;
        <strong>Chips:</strong> @Format(GS.GetAmount("chips"))
    </div>

    <div class="d-flex align-items-center gap-2 mb-2">
        <input type="number" min="0" step="1" class="form-control"
               style="width:140px"
               @bind="_exchangeAmount" @bind:event="oninput" />
        <button class="btn btn-outline-secondary" @onclick="() => SetAmount(10)">+10</button>
        <button class="btn btn-outline-secondary" @onclick="() => SetAmount(50)">+50</button>
        <button class="btn btn-outline-secondary" @onclick="() => SetAmount(100)">+100</button>
        <button class="btn btn-outline-secondary" @onclick="SetMax">Max</button>
    </div>

    <div class="d-flex gap-2">
        <button class="btn btn-primary" @onclick="DoExchange">Exchange 1:1</button>
        <button class="btn btn-outline-secondary" @onclick="ClearAmount">Clear</button>
    </div>

@if (!string.IsNullOrWhiteSpace(_exchangeMsg))
    {
    <div class="mt-2 small text-muted">@_exchangeMsg</div>
    }
</div>;

    private RenderFragment RouletteView => @<div>
        <h4>Roulette</h4>
        <p>Place your bets… (Coming soon)</p>
    @* Put Roulette UI/logic here *@
    </div>;

    private RenderFragment BlackjackView => @<div>
        <h4>Blackjack</h4>
        <p>Try to hit 21. (Coming soon)</p>
    @* Put Blackjack UI/logic here *@
    </div>;

    private static string Format(double v) => Math.Round(v, 0).ToString("N0");

    private void SetAmount(int add)
    {
        _exchangeAmount = Math.Max(0, Math.Round(_exchangeAmount + add, 0));
    }

    private void SetMax()
    {
        var coins = GS.GetAmount("coins");
        _exchangeAmount = Math.Max(0, Math.Round(coins, 0));
    }

    private void ClearAmount() { _exchangeAmount = 0; _exchangeMsg = string.Empty; }

    private void DoExchange()
    {
        var amt = Math.Max(0, Math.Floor(_exchangeAmount));

        if (amt <= 0)
        {
            _exchangeMsg = "Enter an amount greater than 0.";
            return;
        }
        if (!GS.ExchangeCoinsToChips((int)amt))
        {
            _exchangeMsg = "Not enough coins.";
            return;
        }
        _exchangeMsg = $"Exchanged {amt:0} Coins → {amt:0} Chips.";
        _exchangeAmount = 0;
        StateHasChanged();
    }
    // --- Coin Flip state (UI only) ---
private int cfBet = 10;
private bool? cfPickedHeads = true;     // null until chosen
private bool cfSpinning = false;
private string cfFace = "—";
private string cfOutcome = string.Empty;

private int Chips => (int)Math.Floor(GS.GetAmount("chips"));
private bool CfDisableFlip => cfSpinning || cfBet <= 0 || cfPickedHeads is null || cfBet > Chips;

private void CfAdjust(int v) => cfBet = Math.Max(1, cfBet + v);
private void CfMax() => cfBet = Math.Max(1, Chips);
private void CfPick(bool heads) { cfPickedHeads = heads; cfOutcome = string.Empty; }
private void CfClear() { cfPickedHeads = null; cfOutcome = string.Empty; cfFace = "—"; }

// Animation + real resolution via GameState.TryCoinFlip
    private async Task CfFlipWithSpin()
    {
        if (CfDisableFlip) return;

        cfSpinning = true;
        cfOutcome = string.Empty;

        // Quick face roll
        var steps = 18;
        var delay = 40;
        for (int i = 0; i < steps; i++)
        {
            cfFace = (i % 2 == 0) ? "Heads" : "Tails";
            await InvokeAsync(StateHasChanged);
            await Task.Delay(delay);
            delay = Math.Min(delay + 10, 140);
        }

        // Resolve real result using your existing method
        var amt = Math.Max(1, Math.Min(cfBet, Chips));
        var placed = GS.TryCoinFlip(cfPickedHeads!.Value, amt, out var win, out var resultHeads);

        // Show result / message (GameState already adjusts chips)
        if (!placed)
        {
            cfOutcome = "Not enough Chips or invalid amount.";
        }
        else
        {
            cfFace = resultHeads ? "Heads" : "Tails";
            cfOutcome = $"{(win ? "WIN" : "LOSS")} • Result: {cfFace} • Bet: {amt:N0}";
            GS.AwardCasinoXpFromBet(amt, win);

            // If you have a skill XP API, call it here instead of GS.AddXp(...)
            // e.g. SkillService.AddXp(SkillIds.Casino, win ? 8 : 3);
        }

        cfSpinning = false;

        // Trigger UI update from the component side
        StateHasChanged();
    }

    private RenderFragment CoinFlipView => @<div class="card p-3">
    <h4>Coin Flip</h4>

    <div class="row gap" style="align-items:center; margin:.25rem 0 1rem;">
        <div style="font-weight:700;">Chips:</div>
        <div>@Chips</div>
    </div>

    <div class="row gap" style="flex-wrap:wrap; margin-bottom:.75rem;">
        <input class="input" type="number" min="1" style="width:120px"
               @bind="cfBet" @bind:event="oninput" />
        <button class="btn ghost" @onclick="@(() => CfAdjust(10))">+10</button>
        <button class="btn ghost" @onclick="@(() => CfAdjust(50))">+50</button>
        <button class="btn ghost" @onclick="@(() => CfAdjust(100))">+100</button>
        <button class="btn ghost" @onclick="CfMax">Max</button>
    </div>

    <div class="row gap" style="margin-bottom:.5rem;">
        <button class="btn" disabled="@cfSpinning" @onclick="@(() => CfPick(true))">Heads</button>
        <button class="btn" disabled="@cfSpinning" @onclick="@(() => CfPick(false))">Tails</button>
    </div>

    <div class="small" style="margin-bottom:1rem;">
        You have selected:
        <b>@(cfPickedHeads is null ? "—" : (cfPickedHeads.Value ? "Heads" : "Tails"))</b>
    </div>

    <!-- Animated coin -->
    <div class="coin-wrap">
        <div class="coin @(cfSpinning ? "spin" : null)">
            <div class="coin-face">@cfFace</div>
        </div>
    </div>

    <div class="row gap" style="margin-top:1rem;">
        <button class="btn" disabled="@CfDisableFlip" @onclick="CfFlipWithSpin">Flip</button>
        <button class="btn ghost" disabled="@cfSpinning" @onclick="CfClear">Clear</button>
    </div>

@if (!string.IsNullOrWhiteSpace(cfOutcome))
    {
    <p class="small" style="margin-top:.75rem">@cfOutcome</p>
    }
</div>;

private const string TabInventory = "Inventory";
private const string TabGear = "Gear";
    private const string TabBase = "Base";
    private string? rightTab;

    private void ToggleRight(string tab)
    {
        rightTab = rightTab == tab ? null : tab;
        StateHasChanged();
    }

private string craftTab = "Materials";

private void SetCraft(string tab)
{
    craftTab = tab;
    StateHasChanged();
}
    private static string FormatQty(double v)
    {
        v = Math.Floor(v);
        if (v >= 1_000_000_000) return (v / 1_000_000_000d).ToString("0.#") + "B";
        if (v >= 1_000_000) return (v / 1_000_000d).ToString("0.#") + "M";
        if (v >= 1_000) return (v / 1_000d).ToString("0.#") + "K";
        return v.ToString("0");
    }
    private static bool LooksLikeImage(string? icon) =>
    !string.IsNullOrEmpty(icon) &&
    (icon!.StartsWith("http", StringComparison.OrdinalIgnoreCase)
     || icon.StartsWith("/", StringComparison.Ordinal)
     || icon.StartsWith("data:image", StringComparison.OrdinalIgnoreCase)
     || icon.EndsWith(".png", StringComparison.OrdinalIgnoreCase)
     || icon.EndsWith(".svg", StringComparison.OrdinalIgnoreCase)
     || icon.EndsWith(".jpg", StringComparison.OrdinalIgnoreCase));
    // Build rows for the UI from registries + GameState
    private IEnumerable<(string id, string name, long count, int tier, long target)> GetMasteryRows()
    {
        // Local helpers so we don't rely on static GameState in Razor
        static string MidGather(string nodeId) => $"gather:{nodeId}";
        static string MidRecipe(string recipeId) => $"craft:{recipeId}";
        static long TierTarget(int nextTier) => (long)Math.Pow(10, nextTier);

        // Trees (woodcutting)
        foreach (var t in TreeRegistry.All)
        {
            var id = MidGather(t.Id);
            var count = GS.GetMasteryCount(id);
            var tier = GS.GetMasteryTier(id);
            var target = TierTarget(tier + 1);
            yield return (id, t.Name, count, tier, target);
        }

        // Ores (mining)
        foreach (var o in OreRegistry.All)
        {
            var id = MidGather(o.Id);
            var count = GS.GetMasteryCount(id);
            var tier = GS.GetMasteryTier(id);
            var target = TierTarget(tier + 1);
            yield return (id, o.Name, count, tier, target);
        }

        // Crafting recipes — use your GameState collections
        foreach (var r in GS.CraftingRecipes)
        {
            var id = MidRecipe(r.Id);
            var count = GS.GetMasteryCount(id);
            var tier = GS.GetMasteryTier(id);
            var target = TierTarget(tier + 1);
            yield return (id, r.Name, count, tier, target);
        }

        // Smelting recipes — adjust the property name if yours differs
        if (GS.SmeltingRecipes is not null)
        {
            foreach (var r in GS.SmeltingRecipes)
            {
                var id = MidRecipe(r.Id);
                var count = GS.GetMasteryCount(id);
                var tier = GS.GetMasteryTier(id);
                var target = TierTarget(tier + 1);
                yield return (id, r.Name, count, tier, target);
            }
        }
    }

    private static string BarWidth(long count, long target)
    {
        if (target <= 0) return "0%";
        var pct = Math.Clamp((int)Math.Round(100.0 * count / target), 0, 100);
        return $"{pct}%";
    }
    private RenderFragment BasePanel() => __builder =>
    {
        <div class="card" style="padding:12px;">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                <h3 style="margin:0;">Base</h3>

                <!-- New: Buffs button -->
                <button class="btn ghost small" @onclick="OpenBuffs" title="View active base buffs">
                    ✨ Buffs
                </button>
            </div>

            <!-- your existing buildings grid here -->
            <div style="display:grid;gap:10px;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));">
                @foreach (var b in _baseBuildings)
                {
                    var lv = GS.GetBaseLevel(b.Id);
                    <div class="card" style="padding:10px; cursor:pointer;" @onclick="(() => OpenBase(b))">
                        <div style="font-size:28px; margin-bottom:6px;">@b.Icon</div>
                        <div style="font-weight:700;">@b.Name</div>
                        <div class="small" style="opacity:.85;margin-top:2px;">
                            @(lv == 0 ? "Not built" : $"Level {lv}")
                        </div>
                    </div>
                }
            </div>
        </div>

        @if (showBaseModal && selectedB is not null && selectedCost is not null)
        {
            <div style="
                        position:fixed; inset:0; background:rgba(0,0,0,.45);
                        display:flex; align-items:center; justify-content:center; z-index:1000;"
                 @onclick="CloseBase">
                <div class="card" style="min-width:420px; max-width:520px; padding:14px; border:1px solid #2b2c33;"
                     @onclick:stopPropagation="true">
                    @{
                        var lv = GS.GetBaseLevel(selectedB.Id);
                        var nextLv = lv + 1;
                        var buffNow = selectedB.BuffPerLevel * lv;
                        var buffNext = selectedB.BuffPerLevel * nextLv;
                        bool afford = CanAfford(selectedCost);
                    }
                    <div style="display:flex; gap:10px; align-items:center;">
                        <div style="font-size:28px;">@selectedB.Icon</div>
                        <div>
                            <div style="font-weight:800;">@selectedB.Name</div>
                            <div class="small" style="opacity:.85;">@(lv == 0 ? "Not built" : $"Level {lv}") → Level @nextLv</div>
                        </div>
                    </div>

                    <div style="margin-top:10px;">
                        <div style="font-weight:700;">@selectedB.BuffTitle</div>
                        <div class="small" style="opacity:.9;">
                            @((buffNow * 100).ToString("0.#"))% → @((buffNext * 100).ToString("0.#"))%
                        </div>
                    </div>

                    <div style="margin-top:12px;">
                        <div style="font-weight:700; margin-bottom:4px;">Construction Costs</div>
                        @foreach (var kv in selectedCost)
                        {
                            var have = Math.Floor(GS.GetAmount(kv.Key));
                            var need = Math.Floor(kv.Value);
                            var ok = have >= need;
                            var nice = ItemRegistry.TryGet(kv.Key, out var meta) ? meta.Name : NiceId(kv.Key);
                            <div class="small" style="display:flex; justify-content:space-between; gap:8px;">
                                <span>@nice</span>
                                <span style="color:@(ok ? "#9fd18b" : "#f59b9b")">@have / @need</span>
                            </div>
                        }
                    </div>
                    @if (!string.IsNullOrEmpty(baseMsg))
                    {
                        <p class="small" style="color:#f7b3b3; margin-top:8px;">@baseMsg</p>
                    }
                    <div style="display:flex; gap:8px; margin-top:12px;">
                        <button class="btn" disabled="@(!afford)" @onclick="BuildSelected">
                            @(lv == 0 ? "Build" : "Upgrade")
                        </button>
                        <button class="btn ghost" @onclick="CloseBase">Close</button>
                    </div>
                </div>
            </div>
        }
        @if (showBuffsModal)
        {
            <div style="position:fixed; inset:0; background:rgba(0,0,0,.45); display:flex; align-items:center; justify-content:center; z-index:1000;"
                 @onclick="CloseBuffs">
                <div class="card" style="min-width:420px; max-width:520px; padding:14px; border:1px solid #2b2c33;"
                     @onclick:stopPropagation="true">
                    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                        <h3 style="margin:0;">Active Buffs</h3>
                        <button class="btn tiny ghost" @onclick="CloseBuffs">Close</button>
                    </div>

                    <div style="margin-top:10px;">
                        <div style="font-weight:800; margin-bottom:4px;">Woodcutting</div>
                        <div class="small">Base Efficiency: <b>@((GS.WoodcuttingEfficiencyBonus * 100).ToString("0.#"))%</b></div>
                        <div class="small">Tool Bonus: <b>@((GS.WoodcuttingToolBonus * 100).ToString("0.#"))%</b></div>
                        <div class="small" style="margin-top:4px;">Total: <b>@(((GS.WoodcuttingEfficiencyBonus + GS.WoodcuttingToolBonus) * 100).ToString("0.#"))%</b></div>
                    </div>

                    <div style="margin-top:12px;">
                        <div style="font-weight:800; margin-bottom:4px;">Crafting</div>
                        <div class="small">Tool Bonus: <b>@((GS.CraftingToolBonus * 100).ToString("0.#"))%</b></div>
                    </div>

                    <div style="margin-top:12px;">
                        <div style="font-weight:800; margin-bottom:4px;">Mining</div>
                        <div class="small">Tool Bonus: <b>@((GS.MiningToolBonus * 100).ToString("0.#"))%</b></div>
                    </div>
                </div>
            </div>
        }
    };

    // ---------- Base panel model ----------
    private record BaseBuilding(
        string Id,
        string Name,
        string Icon,
        string BuffTitle,
        double BuffPerLevel,                            // e.g., 0.015 == +1.5%
        double CostScale,                               // cost growth per level, e.g., 1.8
        IReadOnlyDictionary<string, double> CostL1);    // base costs for Level 1

    private readonly BaseBuilding[] _baseBuildings =
    {
    new BaseBuilding(
        Id: "shed",
        Name: "Shed",
        Icon: "🏚️",
        BuffTitle: "Woodcutting Efficiency",
        BuffPerLevel: 0.015,                         // +1.5% per level
        CostScale: 1.8,
        CostL1: new Dictionary<string, double>
        {
            [ResourceIds.Coins] = 500_000,
            ["plank_t1"]       = 75,
            ["log_t1"]         = 1500,
        })
};

    // Compute scaled cost for next level
    private Dictionary<string, double> NextCost(BaseBuilding b, int currentLevel)
    {
        // Lv1 uses CostL1; Lv2 uses CostL1 * scale; Lv3 uses * scale^2, etc.
        var mul = Math.Pow(b.CostScale, Math.Max(0, currentLevel));
        return b.CostL1.ToDictionary(kv => kv.Key, kv => Math.Ceiling(kv.Value * mul));
    }

    private bool CanAfford(Dictionary<string, double> cost)
    {
        foreach (var kv in cost)
            if (GS.GetAmount(kv.Key) + 1e-9 < kv.Value) return false;
        return true;
    }

    // Modal state
    private bool showBaseModal;
    private BaseBuilding? selectedB;
    private Dictionary<string, double>? selectedCost;

    private void OpenBase(BaseBuilding b)
    {
        selectedB = b;
        selectedCost = NextCost(b, GS.GetBaseLevel(b.Id));
        showBaseModal = true;
    }

    private void CloseBase() { showBaseModal = false; selectedB = null; selectedCost = null; }
    private string? baseMsg;

    private void BuildSelected()
    {
        if (selectedB is null || selectedCost is null) return;

        baseMsg = null;

        if (GS.TryUpgradeBase(selectedB.Id, selectedCost))
        {
            // refresh next-level cost
            selectedCost = NextCost(selectedB, GS.GetBaseLevel(selectedB.Id));
        }
        else
        {
            baseMsg = "Not enough resources.";
        }
    }
    private static string NiceId(string id)
    {
        // simple fallback prettifier
        var s = id.Replace(':', ' ').Replace('_', ' ').Trim();
        return System.Globalization.CultureInfo.InvariantCulture.TextInfo.ToTitleCase(s);
    }
    // ---- Base: Buffs modal state ----
private bool showBuffsModal;
private void OpenBuffs() { showBuffsModal = true; }
private void CloseBuffs() { showBuffsModal = false; }
    // Close the sell panel
    private void CloseSellPanel()
    {
        selectedItemId = null;
        sellAmount = 1;
        StateHasChanged();
    }

    // Click-away handler (only active when inventory tab is open)
    private void HandleRightClickAway(Microsoft.AspNetCore.Components.Web.MouseEventArgs _)
    {
        if (rightTab == TabInventory && selectedItemId is not null)
            CloseSellPanel();
    }
    RenderFragment ToolsArea() => __builder =>
{
    <h2>Tools</h2>

    <div class="tree-grid">
        @foreach (var r in GS.ToolRecipes)
        {
            var locked = GS.Crafting.Level < r.RequiredLevel;
            var isActive = GS.ActiveRecipeId == r.Id;

            <div class="tree-card @(locked ? "locked" : "") @(isActive ? "active-gather" : "")"
                 style="@(isActive ? "outline:2px solid #0d6efd; background:rgba(13,110,253,.06);" : null)"
                 @onclick="@(() => { if (!locked) { selectedRecipe = r; showCraft = true; craftMsg = ""; } })">
                <div class="tree-icon">@r.Icon</div>
                <div class="tree-name">@r.Name</div>
                <div class="tree-req">Req Lv @r.RequiredLevel</div>
            </div>
        }
    </div>

    @if (showCraft && selectedRecipe is not null && GS.ToolRecipes.Contains(selectedRecipe))
    {
        var r = selectedRecipe!;
        <div class="info card">
            <h3>@r.Name</h3>
            <div class="kv"><span>Requires:</span> <span>Crafting Lv @r.RequiredLevel</span></div>
            <div class="kv"><span>Inputs:</span> <span>@string.Join(", ", r.Inputs.Select(i => $"{i.Amount} {IdToNice(i.ResourceId)}"))</span></div>
            <div class="kv"><span>Outputs:</span> <span>@string.Join(", ", r.Outputs.Select(o => $"{o.Amount} {IdToNice(o.ResourceId)}"))</span></div>
            <div class="kv"><span>Duration:</span> <span>@r.Duration.TotalSeconds.ToString("0.#")s</span></div>

            <div class="row gap">
                <label>Craft (0 = ∞):</label>
                <input class="input small" type="number" min="0" @bind="craftCount" @bind:event="oninput" />
            </div>

            @if (!string.IsNullOrEmpty(craftMsg))
            {
                <p class="small" style="color:#f7b3b3">@craftMsg</p>
            }

            <div class="row gap">
                <button class="btn" type="button"
                        disabled="@(GS.Crafting.Level < r.RequiredLevel || !HasInputsOnce(r))"
                        @onclick="@(() => TryStartCraft(r))">
                    Start
                </button>
                <button class="btn ghost" type="button" @onclick="@(() => showCraft = false)">Close</button>
            </div>
        </div>
    }
};
    void EquipSelected()
    {
        if (selectedItemId is null) return;

        // Determine slot based on item ID
        GearSlot? slot = selectedItemId switch
        {
            // Woodcutting tools
            "axe_t1" or "axe_t2" or "axe_t3" or "axe_t4" => GearSlot.WoodTool,

            // Crafting tools
            "saw_t1" or "saw_t2" or "saw_t3" or "saw_t4" => GearSlot.CraftTool,

            // Mining tools
            "pickaxe_t1" or "pickaxe_t2" or "pickaxe_t3" or "pickaxe_t4" => GearSlot.MiningTool,

            _ => null
        };
        if (slot is null) return;

        if (GS.TryEquip(slot.Value, selectedItemId))
        {
            // Success - the GameState already shows toast
            CloseSellPanel();
        }
    }
    void CloseGatherModal()
    {
        showInfo = false;
        startMsg = "";
    }
    void CloseMiningModal()
    {
        showOre = false;
        mineMsg = "";
    }
}

